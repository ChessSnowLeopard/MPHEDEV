# Participant 模块化重构架构

## 概述

Participant模块已经完成模块化重构，将原本的单体结构拆分为多个职责明确的模块，提高了代码的可维护性和可扩展性。

## 目录结构

```
cmd/Participant/
├── main.go                 # 主程序入口
├── services/               # 核心服务模块
│   ├── participant.go      # 参与方主结构体（重构后）
│   └── key_generation.go   # 密钥生成服务
├── crypto/                 # 加密相关模块
│   ├── key_manager.go      # 密钥管理器
│   └── decryption_service.go # 解密服务
├── network/                # 网络管理模块
│   ├── peer_manager.go     # 对等节点管理
│   └── heartbeat_manager.go # 心跳管理
├── server/                 # HTTP服务器模块
│   ├── http_server.go      # HTTP服务器
│   └── handlers.go         # HTTP处理器
├── coordinator/            # 协调器客户端模块
│   └── client.go           # 协调器客户端
├── types/                  # 类型定义模块
│   └── models.go           # 数据模型
└── utils/                  # 工具模块
    ├── serialization.go    # 序列化工具
    └── type.go             # 类型定义
```

## 模块说明

### 1. services/participant.go
- **职责**: 参与方主结构体，协调各个模块
- **功能**: 
  - 注册到协调器
  - 启动P2P服务器
  - 管理各个子模块
  - 提供主循环和菜单界面

### 2. services/key_generation.go
- **职责**: 密钥生成服务
- **功能**:
  - 生成本地私钥和公钥份额
  - 生成伽罗瓦密钥份额
  - 生成重线性化密钥份额
  - 编码密钥数据

### 3. crypto/key_manager.go
- **职责**: 密钥管理
- **功能**:
  - 存储和管理各种密钥
  - 检查密钥准备状态
  - 提供密钥访问接口

### 4. crypto/decryption_service.go
- **职责**: 解密服务
- **功能**:
  - 生成部分解密份额
  - 发起协同解密请求
  - 聚合解密份额
  - 完成最终解密

### 5. network/peer_manager.go
- **职责**: 对等节点管理
- **功能**:
  - 管理参与方URL列表
  - 向协调器上报URL
  - 发现其他参与方

### 6. network/heartbeat_manager.go
- **职责**: 心跳管理
- **功能**:
  - 发送心跳到协调器
  - 监控在线状态
  - 管理静默模式
  - 检查协作阈值

### 7. server/http_server.go
- **职责**: HTTP服务器
- **功能**:
  - 启动HTTP服务器
  - 管理服务器生命周期

### 8. server/handlers.go
- **职责**: HTTP处理器
- **功能**:
  - 健康检查处理器
  - 部分解密处理器
  - 密钥接收处理器
  - 启动处理器

### 9. coordinator/client.go
- **职责**: 协调器客户端
- **功能**:
  - 与协调器通信
  - 上传密钥份额
  - 查询状态
  - 等待完成

### 10. types/models.go
- **职责**: 数据模型定义
- **功能**:
  - 定义各种数据结构
  - 定义HTTP客户端类型

### 11. utils/
- **职责**: 工具函数
- **功能**:
  - 序列化/反序列化
  - Base64编码/解码
  - 类型定义

## 重构优势

### 1. 职责分离
- 每个模块都有明确的职责
- 降低了模块间的耦合度
- 提高了代码的可读性

### 2. 可维护性
- 修改某个功能只需要修改对应模块
- 减少了代码重复
- 便于单元测试

### 3. 可扩展性
- 新增功能可以独立开发新模块
- 现有模块可以独立升级
- 支持插件化架构

### 4. 代码复用
- 模块可以在不同场景下复用
- 减少了代码冗余
- 提高了开发效率

## 使用方式

### 编译
```bash
cd cmd/Participant
go build -o Participant.exe .
```

### 运行
```bash
./Participant.exe
```

## 迁移说明

### 从旧版本迁移
1. 旧版本的`participant.go`已被删除
2. 新版本使用模块化架构
3. 主要功能保持不变，但内部实现更加清晰

### 主要变化
1. **结构体拆分**: 原来的大结构体拆分为多个小模块
2. **接口统一**: 通过主结构体提供统一接口
3. **依赖注入**: 各个模块通过依赖注入方式组合
4. **错误处理**: 统一的错误处理机制

## 注意事项

1. **编译依赖**: 确保所有依赖模块都已正确导入
2. **配置管理**: 各个模块的配置通过主结构体统一管理
3. **错误处理**: 错误会向上传播到主结构体处理
4. **并发安全**: 各个模块内部实现了并发安全机制

## 未来扩展

1. **插件系统**: 可以基于模块化架构实现插件系统
2. **配置管理**: 可以添加独立的配置管理模块
3. **日志系统**: 可以添加统一的日志管理模块
4. **监控系统**: 可以添加性能监控模块 