# 动态在线状态管理系统设计

## 问题背景

在原有的P2P架构中，参与方在注册时获取的peer列表是静态的，存在以下问题：

1. **静态在线列表**：早上线的参与方无法看到晚上线的参与方
2. **缺乏动态发现**：没有机制让参与方主动发现新加入的参与方
3. **协作阈值不明确**：没有明确的机制确保足够数量的参与方在线才进行解密
4. **菜单干扰**：在菜单模式下后台仍在输出状态信息
5. **操作前检查缺失**：没有在操作前检查在线状态

## 解决方案

设计了一个**动态在线状态管理 + 协作阈值控制 + 静默模式**的解决方案：

### 1. 动态在线状态管理

#### 协调器端 (Coordinator)
- **心跳管理**：维护每个参与方的最后心跳时间
- **在线状态计算**：根据心跳超时时间判断参与方是否在线
- **自动清理**：定期清理超时的参与方
- **状态查询接口**：提供实时在线状态查询

#### 参与方端 (Participant)
- **定期心跳**：每5秒向协调器发送心跳
- **动态发现**：每10秒从协调器获取最新的在线参与方列表
- **状态监控**：实时监控在线状态变化

### 2. 协作阈值控制

- **最小参与方阈值**：设置为总参与方数量（需要所有参与方在线）
- **阈值检查**：在发起协作解密前检查在线参与方数量
- **动态协作**：只有达到阈值才进行协作解密

### 3. 静默模式

- **菜单静默**：进入菜单模式后，后台状态更新不再输出信息
- **按需显示**：只有在用户主动查看状态时才显示信息
- **操作前检查**：在执行协作操作前先检查在线状态

### 4. 实时状态同步

- **心跳机制**：参与方定期向协调器报告状态
- **状态查询**：参与方可以主动查询当前在线状态
- **列表更新**：动态更新在线参与方列表

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   参与方 1       │    │   参与方 2       │    │   参与方 3       │
│                 │    │                 │    │                 │
│ • 心跳 (5s)     │    │ • 心跳 (5s)     │    │ • 心跳 (5s)     │
│ • 状态查询 (10s) │    │ • 状态查询 (10s) │    │ • 状态查询 (10s) │
│ • P2P服务器      │    │ • P2P服务器      │    │ • P2P服务器      │
│ • 静默模式       │    │ • 静默模式       │    │ • 静默模式       │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │        协调器              │
                    │                           │
                    │ • 心跳管理                │
                    │ • 在线状态计算            │
                    │ • 自动清理 (5s)           │
                    │ • 状态查询接口            │
                    │ • 阈值控制                │
                    └───────────────────────────┘
```

## 关键特性

### 1. 动态发现
- 参与方可以实时发现新加入的参与方
- 自动移除离线的参与方
- 支持参与方的动态加入和退出

### 2. 协作阈值控制
- 可配置的最小参与方数量阈值
- 在发起协作操作前进行阈值检查
- 确保系统安全性和可用性

### 3. 静默模式
- 菜单模式下后台状态更新不输出信息
- 只有在用户主动查看时才显示状态
- 提供更清洁的用户界面

### 4. 操作前检查
- 在执行协作操作前先检查在线状态
- 如果在线数量不足，提示用户并阻止操作
- 确保操作的成功率

### 5. 容错机制
- 心跳超时检测离线参与方
- 自动清理无效的参与方记录
- 支持部分参与方离线的场景

### 6. 实时监控
- 参与方可以实时查看在线状态
- 协调器提供状态查询接口
- 支持状态变化的实时通知

## 用户界面流程

### 1. 启动阶段
```
参与方启动 → 注册到协调器 → 启动P2P服务器 → 开始心跳 → 等待密钥分发
```

### 2. 菜单模式
```
进入菜单 → 启用静默模式 → 显示操作选项
```

### 3. 操作流程
```
选择操作1 → 检查在线状态 → 如果满足条件 → 执行协作解密
选择操作2 → 临时禁用静默 → 显示在线状态 → 重新启用静默
选择操作3 → 停止心跳 → 退出程序
```

## API接口

### 协调器接口

#### 心跳接口
```
POST /heartbeat
Content-Type: application/json

{
  "participant_id": 1
}
```

#### 在线状态查询
```
GET /status/online

Response:
{
  "online_count": 2,
  "total_count": 2,
  "min_threshold": 2,
  "can_collaborate": true,
  "online_timeout": 10,
  "heartbeat_interval": 5
}
```

#### 在线参与方列表
```
GET /participants/online

Response:
[
  {"id": 1, "url": "http://localhost:8081"},
  {"id": 2, "url": "http://localhost:8082"}
]
```

### 参与方接口

#### 在线状态查询
```go
func (p *Participant) GetOnlineStatus() (map[string]interface{}, error)
func (p *Participant) GetOnlinePeers() map[int]string
func (p *Participant) ShowOnlineStatus() error
func (p *Participant) checkOnlineStatusBeforeOperation() error
```

## 配置参数

### 协调器配置
- `onlineTimeout`: 心跳超时时间 (默认: 10秒)
- `heartbeatInterval`: 心跳清理间隔 (默认: 5秒)
- `minParticipants`: 最小参与方阈值 (默认: 总参与方数量)

### 参与方配置
- `heartbeatInterval`: 心跳发送间隔 (默认: 5秒)
- `peerUpdateInterval`: 在线列表更新间隔 (默认: 10秒)
- `silentMode`: 静默模式开关 (默认: false)

## 使用示例

### 1. 启动协调器
```bash
cd cmd/Coordinator
go run main.go
# 输入参与方数量: 2
```

### 2. 启动参与方
```bash
cd cmd/Participant
go run main.go
```

### 3. 菜单操作
```
请选择操作：
1. 发起协同解密请求
2. 查看在线状态
3. 退出
输入选项: 1

检查在线状态: 2/2 个参与方在线，最小阈值: 2
可用参与方: 1 个
[协同解密] 自动生成明文并加密...
...
```

### 4. 在线状态不足的情况
```
检查在线状态: 1/2 个参与方在线，最小阈值: 2
[错误] 在线状态检查失败: 在线参与方数量不足，无法进行协作操作 (需要至少 2 个参与方在线，当前 1 个)
```

## 测试程序

使用 `cmd/P2PTest/main.go` 进行自动化测试：

```bash
cd cmd/P2PTest
go run main.go
```

测试程序会：
1. 启动多个参与方
2. 验证心跳机制
3. 测试在线状态查询
4. 验证协作解密功能
5. 验证静默模式功能

## 优势

1. **动态性**：支持参与方的动态加入和退出
2. **可靠性**：通过心跳机制确保状态准确性
3. **安全性**：通过阈值控制确保协作安全
4. **可扩展性**：支持任意数量的参与方
5. **实时性**：提供实时的在线状态信息
6. **用户体验**：静默模式提供清洁的界面
7. **操作安全**：操作前检查确保成功率

## 注意事项

1. **网络延迟**：心跳间隔需要考虑网络延迟
2. **超时设置**：心跳超时时间要合理设置
3. **阈值配置**：最小参与方阈值要根据实际需求调整
4. **资源消耗**：心跳机制会消耗一定的网络和计算资源
5. **静默模式**：确保在需要时能正确显示状态信息

## 未来扩展

1. **状态持久化**：将在线状态保存到数据库
2. **负载均衡**：根据参与方负载进行任务分配
3. **故障恢复**：支持参与方的自动故障恢复
4. **监控告警**：添加系统监控和告警功能
5. **配置界面**：提供图形化的配置界面 