# 多方同态加密系统项目总览

## 项目概述

本项目实现了一个基于P2P架构的多方同态加密系统，支持分布式密钥生成、协同解密和密文刷新功能。系统采用混合架构：协调器负责参数分发和密钥聚合，参与方之间通过P2P网络进行协同计算。

## 系统角色与职责

### 1. 协调器 (Coordinator)
**核心职责：**
- 系统参数管理：生成和分发CKKS参数、CRS种子
- 参与方管理：注册、在线状态监控、URL分发
- 密钥聚合：收集并聚合各参与方的密钥份额
- 密钥测试：验证聚合后的密钥正确性
- 状态同步：维护全局状态，支持参与方查询

**主要功能模块：**
- 参数管理器：生成CKKS参数、CRS种子、伽罗瓦元素
- 密钥管理器：收集和存储密钥份额
- 密钥聚合器：执行多方密钥聚合算法
- 密钥测试器：验证密钥功能正确性
- 参与方管理器：管理参与方注册和在线状态
- HTTP服务器：提供RESTful API接口

### 2. 参与方 (Participant)
**核心职责：**
- 密钥生成：生成本地私钥和各类密钥份额
- P2P通信：与其他参与方直接通信
- 协同计算：执行协同解密和密文刷新
- 在线维护：保持与协调器的心跳连接
- 服务提供：运行HTTP服务器供其他参与方访问

**主要功能模块：**
- 密钥管理器：管理本地密钥和参数
- 解密服务：提供协同解密功能
- 刷新服务：提供密文刷新功能
- 网络管理器：管理P2P连接和在线状态
- 心跳管理器：维护与协调器的连接
- HTTP服务器：提供P2P通信接口

## 系统交互流程

### 1. 系统初始化流程
```
1. 协调器启动 → 生成系统参数和CRS种子
2. 参与方启动 → 注册获取ID → 获取系统参数
3. 参与方生成密钥份额 → 上传给协调器
4. 协调器聚合密钥 → 分发聚合结果
5. 参与方启动P2P服务 → 上报URL给协调器
```

### 2. 协同解密流程
```
1. 发起方检查在线状态 → 确保参与方数量满足阈值
2. 发起方生成解密份额 → 向其他参与方请求份额
3. 其他参与方生成份额 → 返回给发起方
4. 发起方聚合所有份额 → 完成解密
```

### 3. 协同刷新流程
```
1. 发起方生成测试密文 → 进行同态运算消耗深度
2. 发起方生成刷新份额 → 向其他参与方请求份额
3. 其他参与方生成份额 → 返回给发起方
4. 发起方聚合所有份额 → 完成密文刷新
```

## 核心功能模块

### 1. 参数分发机制
- **协调器**：生成CKKS参数、公钥CRP、伽罗瓦CRP、重线性化CRP、刷新CRS
- **参与方**：从协调器获取参数，用于本地密钥生成

### 2. 协同公钥生成
- **参与方**：生成公钥份额，上传给协调器
- **协调器**：聚合所有份额，生成全局公钥
- **测试**：验证公钥加密解密功能

### 3. 伽罗瓦密钥生成
- **参与方**：为每个伽罗瓦元素生成密钥份额
- **协调器**：聚合所有份额，生成伽罗瓦密钥
- **测试**：验证旋转和共轭运算功能

### 4. 重线性化密钥生成
- **参与方**：分两轮生成重线性化密钥份额
- **协调器**：第一轮聚合 → 分发结果 → 第二轮聚合
- **测试**：验证乘法运算功能

### 5. 协同解密
- **P2P架构**：参与方直接通信，无需协调器参与
- **阈值控制**：确保足够数量的参与方在线
- **份额聚合**：本地聚合所有份额完成解密

### 6. 协同刷新
- **P2P架构**：参与方直接通信完成刷新
- **深度消耗**：通过乘法运算模拟真实应用场景
- **CRS分发**：使用协调器分发的CRS生成CRP

### 7. 心跳机制
- **参与方**：定期向协调器发送心跳
- **协调器**：监控参与方在线状态，清理离线节点
- **阈值控制**：基于在线状态控制协同操作

### 8. 注册机制
- **参与方**：启动时向协调器注册获取ID
- **协调器**：分配唯一ID，记录参与方信息
- **URL管理**：参与方上报P2P服务URL

## 目录结构

### cmd/Coordinator/ - 协调器模块
```
cmd/Coordinator/
├── main.go                    # 主程序入口
├── Coordinator.exe            # 编译后的可执行文件
├── README.md                  # 模块说明文档
├── parameters/                # 参数管理模块
│   └── manager.go            # 参数管理器：生成和分发系统参数
├── keys/                      # 密钥管理模块
│   ├── manager.go            # 密钥管理器：收集和存储密钥份额
│   ├── aggregator.go         # 密钥聚合器：执行多方密钥聚合
│   └── tester.go             # 密钥测试器：验证密钥功能
├── participants/              # 参与方管理模块
│   └── manager.go            # 参与方管理器：注册和在线状态管理
├── services/                  # 服务层
│   └── coordinator.go        # 协调器主服务：整合所有功能模块
├── server/                    # 服务器模块
│   └── http_server.go        # HTTP服务器：提供RESTful API
└── utils/                     # 工具模块
    ├── serialization.go      # 序列化工具：编码解码功能
    └── types.go              # 类型定义：数据结构定义
```

### cmd/Participant/ - 参与方模块
```
cmd/Participant/
├── main.go                    # 主程序入口
├── Participant.exe            # 编译后的可执行文件
├── README.md                  # 模块说明文档
├── crypto/                    # 加密功能模块
│   ├── key_manager.go        # 密钥管理器：管理本地密钥
│   ├── decryption_service.go # 解密服务：协同解密功能
│   └── refresh_service.go    # 刷新服务：密文刷新功能
├── services/                  # 服务层
│   ├── participant.go        # 参与方主服务：整合所有功能
│   └── key_generation.go     # 密钥生成服务：生成各类密钥份额
├── network/                   # 网络模块
│   ├── peer_manager.go       # P2P网络管理：管理对等连接
│   └── heartbeat_manager.go  # 心跳管理：维护在线状态
├── server/                    # 服务器模块
│   ├── http_server.go        # HTTP服务器：P2P通信接口
│   └── handlers.go           # 请求处理器：处理P2P请求
├── coordinator/               # 协调器客户端
│   └── client.go             # 协调器客户端：与协调器通信
├── types/                     # 类型定义
│   └── models.go             # 数据结构定义
└── utils/                     # 工具模块
    ├── serialization.go      # 序列化工具
    └── type.go               # 类型转换工具
```

## 技术特点

### 1. 混合架构设计
- **协调器集中管理**：参数分发、密钥聚合、状态同步
- **P2P协同计算**：参与方直接通信，减少协调器负载

### 2. 模块化设计
- **职责分离**：每个模块独立，便于维护和扩展
- **接口清晰**：模块间通过标准接口通信

### 3. 容错机制
- **在线状态监控**：实时监控参与方状态
- **阈值控制**：确保协同操作的安全性
- **心跳机制**：及时发现和处理网络问题

### 4. 安全性保障
- **CRS统一分发**：确保所有参与方使用相同的随机种子
- **份额验证**：验证密钥份额的正确性
- **阈值控制**：防止恶意参与方破坏系统

## 部署说明

### 启动顺序
1. **协调器**：`cd cmd/Coordinator && go run main.go`
2. **参与方**：`cd cmd/Participant && go run main.go`（可启动多个）

### 配置要求
- **参与方数量**：建议2-4个参与方进行测试
- **网络端口**：协调器8080，参与方8081、8082等
- **内存要求**：每个进程约100-200MB内存

### 测试流程
1. 启动协调器，输入参与方数量
2. 启动多个参与方实例
3. 等待密钥生成完成
4. 测试协同解密和刷新功能

## 项目状态

### 已完成功能
- ✅ 参数分发机制
- ✅ 协同公钥生成
- ✅ 伽罗瓦密钥生成
- ✅ 重线性化密钥生成
- ✅ 协同解密功能
- ✅ 协同刷新功能
- ✅ 心跳机制
- ✅ 注册机制
- ✅ P2P网络架构

### 技术亮点
- **CRS统一管理**：解决了随机种子分发问题
- **P2P协同计算**：实现了去中心化的协同操作
- **模块化架构**：便于功能扩展和维护